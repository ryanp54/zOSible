---
  - hosts: zsystem
    gather_facts: no
    vars_files:
      - ./vars/last_args.yaml
    environment:
      "{{environment_vars}}"

    collections:
      - ibm.ibm_zos_core

    tasks:
      - include: ask_pass.yaml

      - name: Generate data set name if none provided
        set_fact:
          data_set_name: "{{ansible_user | upper}}.ZOSIBLE.TMP{{ 99999 | random(start=10000) }}"
        when: data_set_name is not defined or not (data_set_name | bool)

      - debug:
          msg: DSN {{data_set_name}}. DST {{data_set_type}}. LOCAL {{local_file_name}} ET {{exec_type}}

      - include: upload.yaml

      - name: Submit for execution if JCL
        block:
          - zos_job_submit:
              src: "{{data_set_name}}"
              location: DATA_SET
              wait: true
              return_output: true
            register: job_results
          - set_fact:
              job_output: "{{job_results.jobs[0].ddnames}}"
        when: exec_type is not defined or exec_type == 'JCL'

      - name: Execute if REXX
        block:
          - zos_tso_command:
              commands:
                - EXEC 'Z00413.ZOSIBLE.TMP54852' exec
            register: exec_results
          - set_fact:
              job_output: "{{exec_results.output}}"
        when: exec_type is defined and exec_type == 'REXX'
      - debug:
          var: job_output

      - name: Write job output
        template:
          src: "{{ playbook_dir }}/templates/job_output.j2"
          dest: "./output.txt"
          force: yes
        delegate_to: localhost
